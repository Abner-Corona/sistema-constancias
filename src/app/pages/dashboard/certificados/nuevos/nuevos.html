<div class="p-4">
  <form #loteForm="ngForm" (ngSubmit)="onSubmit()">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="field mb-6">
        <app-user-autocomplete
          [label]="'Firmante(s) *'"
          [placeholder]="'Busca la persona responsable de firmar el certificado'"
          [selectedValue]="selectedSigner()"
          (onSelect)="onSignerSelect($event)"
          [multiple]="true"
          [styleClass]="'w-full h-10'"
        ></app-user-autocomplete>
      </div>

      <div class="field">
        <label for="instructor" class="block text-sm font-medium mb-2">Nombre del instructor</label>
        <input
          pInputText
          id="instructor"
          [(ngModel)]="lote.instructor"
          name="instructor"
          class="w-full h-10"
          placeholder="Nombre del instructor"
        />
      </div>
      <div class="field">
        <label for="nombreLote" class="block text-sm font-medium mb-2"
          >Nombre del certificado *</label
        >
        <input
          pInputText
          id="nombreLote"
          [(ngModel)]="lote.nombreLote"
          name="nombreLote"
          required
          class="w-full h-10"
          placeholder="Nombre del certificado"
        />
      </div>
      <div class="field">
        <label for="fecha" class="block text-sm font-medium mb-2">Fecha</label>
        <p-datepicker
          id="fecha"
          [(ngModel)]="loteDate"
          (ngModelChange)="onDateChange($event)"
          name="fecha"
          dateFormat="dd/mm/yy"
          class="w-full"
          placeholder="Seleccione la fecha de certificado"
          [inputStyleClass]="'w-full h-10'"
          [showIcon]="true"
          [readonlyInput]="true"
          [showClear]="true"
        ></p-datepicker>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="field mb-4">
        <label for="fondo" class="block text-sm font-medium mb-2">Fondo *</label>
        <div class="flex items-start gap-2">
          @if (selectedFile()) {
          <p-button
            icon="pi pi-eye"
            (onClick)="openPreview()"
            type="button"
            size="small"
            pTooltip="Previsualizar"
          ></p-button>
          }

          <p-fileUpload
            #fileUpload
            id="fondo"
            accept="image/png,image/jpeg,image/jpg"
            (onSelect)="onFileSelect($event)"
            [multiple]="false"
            [auto]="false"
            mode="basic"
            chooseLabel="Seleccionar Imagen"
            class="flex-1"
          ></p-fileUpload>
          <input type="hidden" [(ngModel)]="lote.fondo" name="fondo" required />
        </div>
      </div>

      <div class="field">
        <label for="orientacion" class="block text-sm font-medium mb-2">Orientación</label>
        <p-select
          id="orientacion"
          [(ngModel)]="lote.orientacion"
          name="orientacion"
          [options]="orientationOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione orientación"
          class="w-full h-10"
        ></p-select>
      </div>
    </div>

    <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Certificados del Lote</h3>
        <div class="flex gap-2">
          <p-button
            icon="pi pi-download"
            (onClick)="exportToExcel()"
            type="button"
            size="small"
            pTooltip="Descargar Excel"
          ></p-button>
          <p-fileUpload
            accept=".xlsx,.xls"
            (onSelect)="onExcelSelect($event)"
            [multiple]="false"
            [auto]="true"
            chooseLabel=" "
            chooseIcon="pi pi-upload"
            mode="basic"
            pTooltip="Cargar Excel"
            size="small"
          ></p-fileUpload>
          <p-button
            icon="pi pi-plus"
            (onClick)="addCertificado()"
            type="button"
            size="small"
            pTooltip="Agregar Certificado"
            [disabled]="
              constancias.length > 0 &&
              (!constancias[constancias.length - 1].nombrePersona ||
                !constancias[constancias.length - 1].email ||
                !constancias[constancias.length - 1].identificador)
            "
          ></p-button>
        </div>
      </div>

      <p-table
        [value]="lote.lstConstanciasLote"
        [scrollable]="true"
        scrollHeight="400px"
        [editMode]="'cell'"
        dataKey="id"
        [paginator]="true"
        [rows]="rows()"
        [rowsPerPageOptions]="rowsOptions"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        [totalRecords]="lote.lstConstanciasLote.length"
        (onPage)="handlePage($event)"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Nombre</th>
            <th>CURP</th>
            <th>RFC</th>
            <th>Correo</th>
            <th>Identificador</th>
            <th>Acciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-constancia let-i="rowIndex">
          <tr>
            <td [pEditableColumn]="constancia.nombrePersona" pEditableColumnField="nombrePersona">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input
                    pInputText
                    [(ngModel)]="constancia.nombrePersona"
                    name="nombrePersona{{ i }}"
                    required
                  />
                </ng-template>
                <ng-template pTemplate="output">
                  {{ constancia.nombrePersona }}
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="constancia.curp" pEditableColumnField="curp">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="constancia.curp" name="curp{{ i }}" />
                </ng-template>
                <ng-template pTemplate="output">
                  {{ constancia.curp }}
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="constancia.rfc" pEditableColumnField="rfc">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="constancia.rfc" name="rfc{{ i }}" />
                </ng-template>
                <ng-template pTemplate="output">
                  {{ constancia.rfc }}
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="constancia.email" pEditableColumnField="email">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input
                    pInputText
                    type="email"
                    [(ngModel)]="constancia.email"
                    name="email{{ i }}"
                    required
                  />
                </ng-template>
                <ng-template pTemplate="output">
                  {{ constancia.email }}
                </ng-template>
              </p-cellEditor>
            </td>
            <td [pEditableColumn]="constancia.identificador" pEditableColumnField="identificador">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input
                    pInputText
                    [(ngModel)]="constancia.identificador"
                    name="identificador{{ i }}"
                    required
                  />
                </ng-template>
                <ng-template pTemplate="output">
                  {{ constancia.identificador }}
                </ng-template>
              </p-cellEditor>
            </td>
            <td>
              <p-button
                icon="pi pi-trash"
                severity="danger"
                (onClick)="removeCertificado(i)"
                type="button"
                size="small"
                pTooltip="Remover"
              ></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>

      @if (constancias.length === 0) {
      <div class="text-center text-gray-500 py-8">
        No hay certificados agregados. Haga clic en "Agregar Certificado" para comenzar.
      </div>
      }
    </div>

    <div class="flex justify-between items-center">
      <p-button
        label="Autollenar Ejemplo"
        icon="pi pi-magic"
        severity="info"
        type="button"
        (onClick)="autollenarEjemplo()"
        pTooltip="Llenar formulario con datos de ejemplo"
      ></p-button>

      <div class="flex gap-4">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          type="button"
          (onClick)="resetLote()"
        ></p-button>

        <p-button
          label="Crear Lote"
          icon="pi pi-check"
          type="button"
          (onClick)="openEditorDialog()"
          [disabled]="!loteForm.valid || lote.lstConstanciasLote.length === 0"
        ></p-button>
      </div>
    </div>
  </form>
</div>

<p-dialog
  [(visible)]="previewDialogVisible"
  header="Previsualización de Imagen"
  [modal]="true"
  [closable]="true"
  (onHide)="closePreview()"
  [style]="{ width: '90vw', height: '90vh' }"
  [contentStyle]="{ overflow: 'hidden' }"
>
  @if (selectedFile()) {
  <div style="display: flex; justify-content: center; align-items: center; height: 100%">
    <img
      [src]="lote.fondo"
      alt="Imagen de fondo"
      style="max-width: 100%; max-height: 100%; object-fit: contain"
    />
  </div>
  }
</p-dialog>

<p-confirmDialog></p-confirmDialog>

<p-dialog
  [(visible)]="formReviewDialogVisible"
  header="Revisión del Formulario"
  [modal]="true"
  [closable]="true"
  (onHide)="closeFormReview()"
  [style]="{ width: '600px' }"
>
  <div class="p-4">
    <h4 class="text-lg font-semibold mb-4">Estado del Formulario</h4>
    <div class="space-y-2">
      <p>
        <strong>Nombre del Lote:</strong>
        {{ lote.nombreLote || 'No especificado' }}
      </p>
      <p><strong>Firmantes:</strong> {{ selectedSignerName() || 'Ninguno' }}</p>
      <p><strong>Orientación:</strong> {{ lote.orientacion || 'No especificada' }}</p>
      <p><strong>Instructor:</strong> {{ lote.instructor || 'No especificado' }}</p>
      <p><strong>Fecha:</strong> {{ lote.fecha || 'No especificada' }}</p>
      <p><strong>Fondo:</strong> {{ selectedFile() ? 'Seleccionado' : 'No seleccionado' }}</p>
    </div>

    <h5 class="text-md font-semibold mt-4 mb-2">Certificados ({{ constancias.length }})</h5>
    @if (constancias.length === 0) {
    <p class="text-gray-500">No hay certificados agregados.</p>
    } @else {
    <div class="space-y-2">
      @for (constancia of lote.lstConstanciasLote; track $index) {
      <div class="border p-2 rounded">
        <p class="font-medium">
          Certificado {{ $index + 1 }}:
          <span
            [class.text-green-600]="
              constancia.nombrePersona && constancia.email && constancia.identificador
            "
            [class.text-red-600]="
              !constancia.nombrePersona || !constancia.email || !constancia.identificador
            "
          >
            {{
              constancia.nombrePersona && constancia.email && constancia.identificador
                ? 'Completo'
                : 'Incompleto'
            }}
          </span>
        </p>
        <ul class="ml-4 text-sm">
          <li>
            Nombre: {{ constancia.nombrePersona || 'Falta' }}
            <span
              [class.text-green-600]="constancia.nombrePersona"
              [class.text-red-600]="!constancia.nombrePersona"
            >
              ({{ constancia.nombrePersona ? 'OK' : 'Falta' }})
            </span>
          </li>
          <li>
            Email: {{ constancia.email || 'Falta' }}
            <span
              [class.text-green-600]="constancia.email"
              [class.text-red-600]="!constancia.email"
            >
              ({{ constancia.email ? 'OK' : 'Inválido' }})
            </span>
          </li>
          <li>
            Identificador: {{ constancia.identificador || 'Falta' }}
            <span
              [class.text-green-600]="constancia.identificador"
              [class.text-red-600]="!constancia.identificador"
            >
              ({{ constancia.identificador ? 'OK' : 'Falta' }})
            </span>
          </li>
        </ul>
      </div>
      }
    </div>
    }
  </div>
</p-dialog>
@if(editorDialogVisible()) {

<app-editor-certificados
  [(visible)]="editorDialogVisible"
  [selectedFile]="selectedFile()"
  [fondoValue]="lote.fondo || ''"
  [loading]="loading()"
  [formValue]="lote"
  [orientation]="orientationValue"
  (orientationChange)="lote.orientacion = $event"
  [(editorContent)]="editorContent"
  (onCancel)="closeEditorDialog()"
  (onSave)="onSubmit(); closeEditorDialog()"
></app-editor-certificados>
}
