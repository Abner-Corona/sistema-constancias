<div class="p-6">
  <div class="max-w-4xl mx-auto">
    <p-card class="shadow-lg">
      <h3 class="text-lg font-semibold mb-4">
        Captura la información para envío de correo según el firmante
      </h3>

      <div class="mb-6">
        <label class="block text-sm font-medium mb-2">Busca un firmante</label>
        <p-iconField class="w-full">
          @if (usersLoading()) {
          <p-inputIcon class="pi pi-spin pi-spinner" />
          }

          <p-autocomplete
            name="idFirmante"
            [(ngModel)]="selectedUserModel"
            (ngModelChange)="onModelChange($event)"
            [suggestions]="filteredUsers()"
            (completeMethod)="filterUsers($event)"
            optionLabel="nombre"
            [dropdown]="true"
            [placeholder]="'Busca la persona responsable de firmar los certificados'"
            (onSelect)="onUserSelect($event)"
            [showClear]="true"
            class="w-full h-10"
          ></p-autocomplete>
        </p-iconField>
      </div>

      <form #form="ngForm" (ngSubmit)="onSubmit(form)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-1">
            <label for="nombre" class="block text-sm font-medium"> Título del correo </label>
            <input
              pInputText
              id="nombre"
              [ngModel]="config().nombre"
              (ngModelChange)="setConfigProp('nombre', $event)"
              name="nombre"
              placeholder="Introduce el titulo del correo de salida"
              class="w-full"
            />
          </div>

          <div class="space-y-1">
            <label for="emailEnvio" class="block text-sm font-medium"> Email de Envío * </label>
            <input
              pInputText
              id="emailEnvio"
              type="email"
              [ngModel]="config().emailEnvio"
              (ngModelChange)="setConfigProp('emailEnvio', $event)"
              name="emailEnvio"
              #emailEnvio="ngModel"
              required
              email
              placeholder="Introduce el correo de salida de los certificados"
              class="w-full"
              [class.ng-invalid]="emailEnvio.invalid && emailEnvio.touched"
            />
            @if (emailEnvio.invalid && emailEnvio.touched) {
            <small class="text-red-500 block text-xs">
              @if (emailEnvio.errors?.['required']) {
              <span>El email es requerido</span>
              } @if (emailEnvio.errors?.['email']) {
              <span>Formato de email inválido</span>
              }
            </small>
            }
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-1">
            <label for="smtp" class="block text-sm font-medium"> Servidor SMTP </label>
            <input
              pInputText
              id="smtp"
              [ngModel]="config().smtp"
              (ngModelChange)="setConfigProp('smtp', $event)"
              name="smtp"
              placeholder="Introduce el SMTP"
              class="w-full"
            />
          </div>

          <div class="space-y-1">
            <label for="puerto" class="block text-sm font-medium"> Puerto </label>
            <input
              pInputText
              id="puerto"
              [ngModel]="config().puerto"
              (ngModelChange)="setConfigProp('puerto', $event)"
              name="puerto"
              placeholder="Introduce el puerto"
              class="w-full"
            />
          </div>
        </div>

        <div class="space-y-2">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-1">
              <label for="passwordEnvio" class="block text-sm font-medium">
                Contraseña del correo*
              </label>
              <p-password
                id="passwordEnvio"
                [ngModel]="config().passwordEnvio"
                (ngModelChange)="setConfigProp('passwordEnvio', $event)"
                name="passwordEnvio"
                #passwordEnvio="ngModel"
                required
                [minlength]="6"
                placeholder="Introduce la contraseña del correo de salida"
                class="w-full"
                inputStyleClass="w-full"
                [toggleMask]="true"
                [feedback]="false"
                [class.ng-invalid]="passwordEnvio.invalid && passwordEnvio.touched"
              ></p-password>
              @if ( passwordEnvio.invalid && passwordEnvio.touched ) {
              <small class="text-red-500 block text-xs">
                @if (passwordEnvio.errors?.['required']) {
                <span>La contraseña es requerida</span>
                } @if (passwordEnvio.errors?.['minlength']) {
                <span>La contraseña debe tener al menos 6 caracteres</span>
                }
              </small>
              }
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">Opciones de Configuración</h3>

          <div class="flex flex-col space-y-2">
            <div class="flex items-center space-x-3">
              <input
                type="checkbox"
                id="defaultCredentials"
                [ngModel]="config().defaultCredentials"
                (ngModelChange)="setConfigProp('defaultCredentials', $event)"
                name="defaultCredentials"
                class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"
              />
              <label for="defaultCredentials" class="text-sm font-medium">
                Usar credenciales por defecto
              </label>
            </div>

            <div class="flex items-center space-x-3">
              <input
                type="checkbox"
                id="enableSsl"
                [ngModel]="config().enableSsl"
                (ngModelChange)="setConfigProp('enableSsl', $event)"
                name="enableSsl"
                class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500"
              />
              <label for="enableSsl" class="text-sm font-medium"> Habilitar SSL/TLS </label>
            </div>
          </div>
        </div>

        <div class="flex justify-end space-x-4 pt-6 border-t">
          <p-button
            label="Guardar"
            icon="pi pi-check"
            type="submit"
            [loading]="saving()"
            [disabled]="form.invalid"
          ></p-button>
        </div>
      </form>
    </p-card>
  </div>
</div>

<p-confirmDialog></p-confirmDialog>
